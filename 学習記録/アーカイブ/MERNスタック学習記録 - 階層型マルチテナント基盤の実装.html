<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERNスタック学習記録 - 階層型マルチテナント基盤の実装</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.8;
            color: #343a40;
            max-width: 960px;
            margin: 40px auto;
            padding: 0 20px;
            background-color: #f8f9fa;
        }

        h1,
        h2,
        h3 {
            color: #005f73;
            border-bottom: 2px solid #0a9396;
            padding-bottom: 10px;
            margin-top: 40px;
        }

        h1 {
            text-align: center;
            border-bottom-width: 4px;
            font-size: 2.5em;
        }

        h2 {
            background-color: #e9ecef;
            padding: 12px 15px;
            border-left: 6px solid #0a9396;
            font-size: 1.8em;
        }

        code {
            background-color: #e0e0e0;
            padding: 3px 7px;
            border-radius: 5px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.9em;
        }

        pre {
            background-color: #212529;
            color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .milestone {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
            padding: 20px;
            margin: 25px 0;
        }

        .debug-story {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin: 25px 0;
        }

        .tech-highlight {
            background-color: #e0fbfc;
            border-left: 5px solid #2ec4b6;
            padding: 20px;
            margin: 25px 0;
        }

        ul {
            padding-left: 25px;
        }

        li {
            margin-bottom: 12px;
        }
    </style>
</head>

<body>

    <h1>MERNスタック学習記録 - 階層型マルチテナント基盤の実装</h1>

    <div class="card milestone">
        <h2>大きな達成：組織階層の可視化と管理</h2>
        <p>
            基本的なマルチテナント基盤の上に、テナントが親子関係を持つ<strong>「階層型マルチテナント」</strong>のデータ構造を導入しました。そして、管理者がその組織階層を視覚的に確認し、新しい子テナント（部署）を自由に追加できるUIとAPIを実装することに成功しました。
        </p>
        <p>
            これにより、私たちのアプリケーションは、単一の組織だけでなく、本社・支社・部署といった複雑な組織構造を持つ大企業にも対応可能な、極めてスケーラブルなアーキテクチャの礎を築きました。
        </p>
    </div>

    <div class="card">
        <h2>核心的な学び：MongoDB `$graphLookup` の活用</h2>
        <div class="tech-highlight">
            <h3>自己参照リレーションシップと階層クエリ</h3>
            <p>
                今回の開発で最も高度な学びは、MongoDBの強力な集計パイプラインステージである<code>$graphLookup</code>の活用です。
            </p>
            <ul>
                <li><strong>自己参照モデル:</strong>
                    <code>tenant.model.js</code>に<code>parent</code>フィールドを追加し、テナント自身が親子関係を持てるデータ構造を設計しました。</li>
                <li><strong>階層データの一括取得:</strong>
                    <code>$graphLookup</code>を駆使することで、ログインユーザーがどの階層にいても、その組織全体のツリー構造（親、子、孫...）を一度のデータベースクエリで効率的に取得する、高度なデータ取得ロジックを構築しました。
                </li>
            </ul>
            <pre><code>// server/routes/tenants.js (GET /) の一部
const hierarchy = await Tenant.aggregate([
  // ...
  { $graphLookup: { from: 'tenants', ... } }, // 親を遡る
  // ...
  { $graphLookup: { from: 'tenants', ... } }, // 子を辿る
  // ...
]);</code></pre>
        </div>
    </div>

    <div class="card debug-story">
        <h2>デバッグの物語：複雑さとの戦い</h2>
        <p>
            階層構造という複雑な概念の導入は、数々の難解なバグとの戦いでもありました。しかし、それらを一つずつ解決したことで、私たちはシステムへの理解を格段に深めました。
        </p>
        <ol>
            <li><strong>ミドルウェアの連鎖地獄:</strong>
                <code>router.use(admin)</code>が意図せず後続のAPIに影響を与え、ログインできなくなる問題に直面。ミドルウェアの適用範囲を個別のルートに限定することで解決し、Expressの動作原理を深く理解しました。
            </li>
            <li><strong>サーバーダウンの謎:</strong>
                <code>ECONNREFUSED</code>エラーから、バックエンドサーバーが起動していない、またはクラッシュしていることを見抜きました。フロントエンドとバックエンドを連携させる開発の基本を再確認しました。
            </li>
            <li><strong>`BSONError`との対決:</strong>
                <code>while</code>ループを使った非効率なルート探索ロジックが、Mongooseのバージョンと衝突してエラーを発生させていることを特定。これをきっかけに、より高度で堅牢な<code>$graphLookup</code>を用いたロジックへと刷新しました。
            </li>
            <li><strong>「表示されない」バグの追跡:</strong>
                データが作成されているのにUIに表示されない問題に対し、<code>POST</code>処理と<code>GET</code>処理の両方に<code>console.log</code>を仕掛け、データの流れを可視化。最終的に<code>tenant.model.js</code>のスキーマ定義の不備（<code>parent</code>フィールドの欠落）を突き止めました。
            </li>
        </ol>
        <p>
            この一連のデバッグは、システムの振る舞いを多角的に観察し、根本原因を特定する、まさにプロフェッショナルなトラブルシューティングのプロセスでした。
        </p>
    </div>

    <div class="card">
        <h2>現在地と次のステップ</h2>
        <p>
            現在、アプリケーションは<strong>「組織の階層構造をデータとして持ち、それをUIで管理できる」</strong>状態です。しかし、この階層構造はまだ「見た目」だけであり、実際のアクセス制御には反映されていません。
        </p>
        <p>
            次のステップでは、この階層構造に魂を吹き込みます。<strong>「親組織のユーザーは、子組織のデータ（TODOなど）を閲覧・操作できる」</strong>という、階層型アクセス制御のロジックを実装し、真のエンタープライズ向け機能を完成させましょう。
        </p>
    </div>

</body>

</html>